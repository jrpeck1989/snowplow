"use strict";(self.webpackChunkdocsite_poc_github_io=self.webpackChunkdocsite_poc_github_io||[]).push([[54230],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>A});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),A=a,m=u["".concat(l,".").concat(A)]||u[A]||c[A]||o;return n?r.createElement(m,i(i({ref:t},d),{},{components:n})):r.createElement(m,i({ref:t},d))}));function A(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},10327:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const o={title:"Databricks loader",date:"2022-05-27",sidebar_position:300},i=void 0,s={unversionedId:"pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader/index",id:"pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader/index",title:"Databricks loader",description:"Setting up Databricks",source:"@site/docs/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader/index.md",sourceDirName:"pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader",slug:"/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader/",permalink:"/docs/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader/",draft:!1,editUrl:"https://github.com/snowplow/snowplow.github.io/tree/main/docs/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/databricks-loader/index.md",tags:[],version:"current",lastUpdatedAt:1662725915,formattedLastUpdatedAt:"Sep 9, 2022",sidebarPosition:300,frontMatter:{title:"Databricks loader",date:"2022-05-27",sidebar_position:300},sidebar:"defaultSidebar",previous:{title:"Snowflake loader",permalink:"/docs/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/snowflake-loader/"},next:{title:"Monitoring",permalink:"/docs/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/monitoring/"}},l={},p=[{value:"Setting up Databricks",id:"setting-up-databricks",level:2},{value:"Downloading the artefact",id:"downloading-the-artefact",level:3},{value:"Configuring <code>rdb-loader-databricks</code>",id:"configuring-rdb-loader-databricks",level:3},{value:"Running the Databricks loader",id:"running-the-databricks-loader",level:3}],d={toc:p};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"setting-up-databricks"},"Setting up Databricks"),(0,a.kt)("p",null,"The following resources need to be created:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://docs.databricks.com/administration-guide/cloud-configurations/aws/instance-profiles.html"},"AWS instance profile")," for giving permission to Databricks cluster to access S3 buckets securely"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://docs.databricks.com/administration-guide/cloud-configurations/aws/instance-profiles.html#step-5-add-the-instance-profile-to-databricks"},"Databricks cluster")," configured with the instance profile created above"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://docs.databricks.com/dev-tools/api/latest/authentication.html"},"Databricks access token"))),(0,a.kt)("p",null,"Also, ",(0,a.kt)("inlineCode",{parentName:"p"},"events")," table needs to be created before starting the application for the first time:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Statement for creating events table")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"CREATE TABLE IF NOT EXISTS snowplow.events (\n  -- App\n  app_id                      VARCHAR(255),\n  platform                    VARCHAR(255),\n  -- Date/time\n  etl_tstamp                  TIMESTAMP,\n  collector_tstamp            TIMESTAMP       NOT NULL,\n  dvce_created_tstamp         TIMESTAMP,\n  -- Event\n  event                       VARCHAR(128),\n  event_id                    CHAR(36)        NOT NULL,\n  txn_id                      INTEGER,\n  -- Namespacing and versioning\n  name_tracker                VARCHAR(128),\n  v_tracker                   VARCHAR(100),\n  v_collector                 VARCHAR(100)    NOT NULL,\n  v_etl                       VARCHAR(100)    NOT NULL,\n  -- User and visit\n  user_id                     VARCHAR(255),\n  user_ipaddress              VARCHAR(128),\n  user_fingerprint            VARCHAR(128),\n  domain_userid               VARCHAR(128),\n  domain_sessionidx           SMALLINT,\n  network_userid              VARCHAR(128),\n  -- Location\n  geo_country                 CHAR(2),\n  geo_region                  CHAR(3),\n  geo_city                    VARCHAR(75),\n  geo_zipcode                 VARCHAR(15),\n  geo_latitude                DOUBLE,\n  geo_longitude               DOUBLE,\n  geo_region_name             VARCHAR(100),\n  -- IP lookups\n  ip_isp                      VARCHAR(100),\n  ip_organization             VARCHAR(128),\n  ip_domain                   VARCHAR(128),\n  ip_netspeed                 VARCHAR(100),\n  -- Page\n  page_url                    VARCHAR(4096),\n  page_title                  VARCHAR(2000),\n  page_referrer               VARCHAR(4096),\n  -- Page URL components\n  page_urlscheme              VARCHAR(16),\n  page_urlhost                VARCHAR(255),\n  page_urlport                INTEGER,\n  page_urlpath                VARCHAR(3000),\n  page_urlquery               VARCHAR(6000),\n  page_urlfragment            VARCHAR(3000),\n  -- Referrer URL components\n  refr_urlscheme              VARCHAR(16),\n  refr_urlhost                VARCHAR(255),\n  refr_urlport                INTEGER,\n  refr_urlpath                VARCHAR(6000),\n  refr_urlquery               VARCHAR(6000),\n  refr_urlfragment            VARCHAR(3000),\n  -- Referrer details\n  refr_medium                 VARCHAR(25),\n  refr_source                 VARCHAR(50),\n  refr_term                   VARCHAR(255),\n  -- Marketing\n  mkt_medium                  VARCHAR(255),\n  mkt_source                  VARCHAR(255),\n  mkt_term                    VARCHAR(255),\n  mkt_content                 VARCHAR(500),\n  mkt_campaign                VARCHAR(255),\n  -- Custom structured event\n  se_category                 VARCHAR(1000),\n  se_action                   VARCHAR(1000),\n  se_label                    VARCHAR(4096),\n  se_property                 VARCHAR(1000),\n  se_value                    DOUBLE,\n  -- Ecommerce\n  tr_orderid                  VARCHAR(255),\n  tr_affiliation              VARCHAR(255),\n  tr_total                    DECIMAL(18,2),\n  tr_tax                      DECIMAL(18,2),\n  tr_shipping                 DECIMAL(18,2),\n  tr_city                     VARCHAR(255),\n  tr_state                    VARCHAR(255),\n  tr_country                  VARCHAR(255),\n  ti_orderid                  VARCHAR(255),\n  ti_sku                      VARCHAR(255),\n  ti_name                     VARCHAR(255),\n  ti_category                 VARCHAR(255),\n  ti_price                    DECIMAL(18,2),\n  ti_quantity                 INTEGER,\n  -- Page ping\n  pp_xoffset_min              INTEGER,\n  pp_xoffset_max              INTEGER,\n  pp_yoffset_min              INTEGER,\n  pp_yoffset_max              INTEGER,\n  -- User Agent\n  useragent                   VARCHAR(1000),\n  -- Browser\n  br_name                     VARCHAR(50),\n  br_family                   VARCHAR(50),\n  br_version                  VARCHAR(50),\n  br_type                     VARCHAR(50),\n  br_renderengine             VARCHAR(50),\n  br_lang                     VARCHAR(255),\n  br_features_pdf             BOOLEAN,\n  br_features_flash           BOOLEAN,\n  br_features_java            BOOLEAN,\n  br_features_director        BOOLEAN,\n  br_features_quicktime       BOOLEAN,\n  br_features_realplayer      BOOLEAN,\n  br_features_windowsmedia    BOOLEAN,\n  br_features_gears           BOOLEAN,\n  br_features_silverlight     BOOLEAN,\n  br_cookies                  BOOLEAN,\n  br_colordepth               VARCHAR(12),\n  br_viewwidth                INTEGER,\n  br_viewheight               INTEGER,\n  -- Operating System\n  os_name                     VARCHAR(50),\n  os_family                   VARCHAR(50),\n  os_manufacturer             VARCHAR(50),\n  os_timezone                 VARCHAR(255),\n  -- Device/Hardware\n  dvce_type                   VARCHAR(50),\n  dvce_ismobile               BOOLEAN,\n  dvce_screenwidth            INTEGER,\n  dvce_screenheight           INTEGER,\n  -- Document\n  doc_charset                 VARCHAR(128),\n  doc_width                   INTEGER,\n  doc_height                  INTEGER,\n  -- Currency\n  tr_currency                 CHAR(3),\n  tr_total_base               DECIMAL(18, 2),\n  tr_tax_base                 DECIMAL(18, 2),\n  tr_shipping_base            DECIMAL(18, 2),\n  ti_currency                 CHAR(3),\n  ti_price_base               DECIMAL(18, 2),\n  base_currency               CHAR(3),\n  -- Geolocation\n  geo_timezone                VARCHAR(64),\n  -- Click ID\n  mkt_clickid                 VARCHAR(128),\n  mkt_network                 VARCHAR(64),\n  -- ETL tags\n  etl_tags                    VARCHAR(500),\n  -- Time event was sent\n  dvce_sent_tstamp            TIMESTAMP,\n  -- Referer\n  refr_domain_userid          VARCHAR(128),\n  refr_dvce_tstamp            TIMESTAMP,\n  -- Session ID\n  domain_sessionid            CHAR(128),\n  -- Derived timestamp\n  derived_tstamp              TIMESTAMP,\n  -- Event schema\n  event_vendor                VARCHAR(1000),\n  event_name                  VARCHAR(1000),\n  event_format                VARCHAR(128),\n  event_version               VARCHAR(128),\n  -- Event fingerprint\n  event_fingerprint           VARCHAR(128),\n  -- True timestamp\n  true_tstamp                 TIMESTAMP,\n  -- Collector timestamp date for partitioning\n  collector_tstamp_date       DATE GENERATED ALWAYS AS (DATE(collector_tstamp))\n)\nPARTITIONED BY (collector_tstamp_date, event_name);\n")),(0,a.kt)("h3",{id:"downloading-the-artefact"},"Downloading the artefact"),(0,a.kt)("p",null,"The asset is published as a jar file attached to the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/snowplow/snowplow-rdb-loader/releases"},"Github release notes")," for each version."),(0,a.kt)("p",null,"It's also available as a Docker image on Docker Hub under ",(0,a.kt)("inlineCode",{parentName:"p"},"snowplow/rdb-loader-databricks:4.2.0"),"."),(0,a.kt)("h3",{id:"configuring-rdb-loader-databricks"},"Configuring ",(0,a.kt)("inlineCode",{parentName:"h3"},"rdb-loader-databricks")),(0,a.kt)("p",null,"The loader takes two configuration files:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"a ",(0,a.kt)("inlineCode",{parentName:"li"},"config.hocon")," file with application settings"),(0,a.kt)("li",{parentName:"ul"},"an ",(0,a.kt)("inlineCode",{parentName:"li"},"iglu_resolver.json")," file with the resolver configuration for your ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/snowplow/iglu"},"Iglu")," schema registry.")),(0,a.kt)("p",null,"An example of the minimal required config for the Databricks loader can be found ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/snowplow/snowplow-rdb-loader/blob/master/config/databricks.config.minimal.hocon"},"here")," and a more detailed one ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/snowplow/snowplow-rdb-loader/blob/master/config/databricks.config.reference.hocon"},"here"),". For details about each setting, see the ",(0,a.kt)("a",{parentName:"p",href:"/docs/pipeline-components-and-applications/loaders-storage-targets/snowplow-rdb-loader-3-0-0/loading-transformed-data/rdb-loader-configuration-reference/"},"configuration reference"),"."),(0,a.kt)("p",null,"See ",(0,a.kt)("a",{parentName:"p",href:"/docs/pipeline-components-and-applications/iglu/iglu-resolver/"},"here")," for details on how to prepare the Iglu resolver file."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NOTE:")," All self-describing schemas for events processed by RDB Loader ",(0,a.kt)("strong",{parentName:"p"},"must")," be hosted on ",(0,a.kt)("a",{parentName:"p",href:"/docs/pipeline-components-and-applications/iglu/iglu-repositories/iglu-server/"},"Iglu Server")," 0.6.0 or above. ",(0,a.kt)("a",{parentName:"p",href:"/docs/pipeline-components-and-applications/iglu/iglu-repositories/iglu-central/"},"Iglu Central")," is a registry containing Snowplow-authored schemas. If you want to use them alongside your own, you will need to add it to your resolver file. Keep it mind that it could override your own private schemas if you give it higher priority. For details on this see ",(0,a.kt)("a",{parentName:"p",href:"https://discourse.snowplow.io/t/important-changes-to-iglu-centrals-api-for-schema-lists/5720#how-will-this-affect-my-snowplow-pipeline-3"},"here"),"."),(0,a.kt)("h3",{id:"running-the-databricks-loader"},"Running the Databricks loader"),(0,a.kt)("p",null,"The two config files need to be passed in as base64-encoded strings:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ docker run snowplow/rdb-loader-databricks:4.2.0 \\\n  --iglu-config $RESOLVER_BASE64 \\\n  --config $CONFIG_BASE64\n")))}c.isMDXComponent=!0}}]);